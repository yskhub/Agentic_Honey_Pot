name: Integration (docker-compose)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  integration-compose:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Start services with docker-compose
        run: |
          docker compose -f docker-compose.postgres.yml up -d

      - name: Wait for Postgres
        run: |
          python - <<'PY'
          import time, sys
          import psycopg2
          for i in range(30):
              try:
                  conn = psycopg2.connect(dbname='sentinel_db', user='sentinel', password='sentinel_pass', host='127.0.0.1', port=5432)
                  conn.close()
                  print('Postgres ready')
                  sys.exit(0)
              except Exception as e:
                  print('Waiting for Postgres...', e)
                  time.sleep(2)
          print('Postgres not ready', file=sys.stderr)
          sys.exit(1)
          PY

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run pytest
        env:
          DATABASE_URL: postgresql+psycopg2://sentinel:sentinel_pass@127.0.0.1:5432/sentinel_db
        run: |
          # Apply Alembic migrations and verify current revision before running tests
          alembic upgrade head
          alembic current
          pytest -q

      - name: Tear down
        if: always()
        run: |
          docker compose -f docker-compose.postgres.yml down -v
